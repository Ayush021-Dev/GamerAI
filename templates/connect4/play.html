{% extends "base.html" %}

{% block title %}Connect-4 - Game Hub{% endblock %}

{% block content %}
<div class="container">
    <div class="game-header">
        <h1 class="game-title">Connect-4</h1>
        
        <div class="game-controls">
            <div class="player-options">
                <button id="human-first" class="btn btn-option active">You First (ðŸŸ¡)</button>
                <button id="ai-first" class="btn btn-option">Bot First (ðŸ”´)</button>
            </div>
            
            <div class="difficulty-section">
                <select id="difficulty" class="difficulty-dropdown">
                    <option value="easy">Easy</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            
            <button id="new-game" class="btn btn-primary">New Game</button>
        </div>
        
        <div class="game-message" id="game-message">
            Choose difficulty and start a new game!
        </div>
    </div>
    
    <div class="board-container">
        <div id="connect4-board" class="connect4-board">
            <div class="column-indicators" id="column-indicators"></div>
        </div>
    </div>
    
    <div class="score-section">
        <div class="score-item">
            <div class="score-label">You (ðŸŸ¡):</div>
            <div class="score-value" id="player-score">0</div>
        </div>
        <div class="score-item">
            <div class="score-label">Bot (ðŸ”´):</div>
            <div class="score-value" id="ai-score">0</div>
        </div>
        <div class="score-item">
            <div class="score-label">Draws:</div>
            <div class="score-value" id="draw-score">0</div>
        </div>
    </div>
</div>

<!-- Game Over Overlay -->
<div id="game-over-overlay" class="game-over-overlay">
    <div class="game-over-content">
        <div class="game-over-icon" id="game-over-icon">ðŸŽ‰</div>
        <div class="game-over-title" id="game-over-title">You Win!</div>
        <div class="game-over-subtitle" id="game-over-subtitle">Congratulations!</div>
        <button id="play-again-btn" class="btn btn-play-again">Play Again</button>
    </div>
</div>

<style>
* {
    box-sizing: border-box;
}

.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.game-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.game-title {
    font-size: 3rem;
    font-weight: bold;
    margin: 0 0 25px 0;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
    letter-spacing: 2px;
}

.game-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.player-options {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 15px;
    font-family: inherit;
}

.btn-option {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 2px solid transparent;
}

.btn-option.active {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
}

.btn-option:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
}

.btn-primary {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.btn-primary:active {
    transform: translateY(0);
}

.difficulty-dropdown {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    font-size: 15px;
    transition: all 0.3s ease;
}

.difficulty-dropdown:hover {
    background: white;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.game-message {
    font-size: 1.2rem;
    font-weight: 500;
    margin-top: 15px;
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    display: inline-block;
}

.board-container {
    display: flex;
    justify-content: center;
    margin: 40px 0;
    perspective: 1000px;
}

.connect4-board {
    position: relative;
    display: grid;
    grid-template-columns: repeat(7, 75px);
    grid-template-rows: repeat(6, 75px);
    gap: 10px;
    padding: 25px;
    background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    border-radius: 20px;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
    transition: transform 0.3s ease;
}

.connect4-board:hover {
    transform: translateY(-5px);
}

.column-indicators {
    position: absolute;
    top: -35px;
    left: 25px;
    right: 25px;
    display: flex;
    gap: 10px;
    pointer-events: none;
}

.column-indicator {
    width: 75px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: all;
    cursor: pointer;
}

.column-indicator.active {
    opacity: 1;
    animation: bounce-indicator 0.6s ease-in-out infinite;
}

@keyframes bounce-indicator {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.connect4-cell {
    width: 75px;
    height: 75px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    cursor: pointer;
    transition: all 0.2s ease;
    border: 3px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.connect4-cell:hover:not(.player):not(.ai) {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
}

.connect4-cell.player {
    background: radial-gradient(circle at 30% 30%, #fde047 0%, #fbbf24 50%, #f59e0b 100%);
    border-color: #d97706;
    box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5), inset -2px -2px 5px rgba(0, 0, 0, 0.2);
}

.connect4-cell.ai {
    background: radial-gradient(circle at 30% 30%, #fca5a5 0%, #ef4444 50%, #dc2626 100%);
    border-color: #b91c1c;
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5), inset -2px -2px 5px rgba(0, 0, 0, 0.2);
}

.connect4-cell.winning {
    animation: pulse-win 1s ease-in-out infinite;
    z-index: 10;
}

@keyframes pulse-win {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.8);
    }
    50% {
        transform: scale(1.15);
        box-shadow: 0 0 50px rgba(16, 185, 129, 1);
    }
}

.connect4-cell.falling {
    animation: fall-down 2s cubic-bezier(0.34, 1.56, 0.64, 1);
}


@keyframes fall-down {
    0% {
        transform: translateY(-500px) scale(0.8);
        opacity: 0;
    }
    60% {
        transform: translateY(10px) scale(1.05);
    }
    80% {
        transform: translateY(-5px) scale(0.98);
    }
    100% {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.score-section {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 40px;
    flex-wrap: wrap;
}

.score-item {
    text-align: center;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    padding: 20px 35px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.score-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
}

.score-label {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 8px;
    font-weight: 500;
}

.score-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #fbbf24;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

/* Game Over Overlay */
.game-over-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fade-in 0.3s ease;
}

.game-over-overlay.show {
    display: flex;
}

@keyframes fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
}

.game-over-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 50px 60px;
    border-radius: 25px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: slide-up 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    max-width: 90%;
}

@keyframes slide-up {
    from {
        transform: translateY(100px) scale(0.8);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.game-over-icon {
    font-size: 100px;
    margin-bottom: 20px;
    animation: bounce-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s backwards;
}

@keyframes bounce-in {
    from {
        transform: scale(0);
    }
    to {
        transform: scale(1);
    }
}

.game-over-title {
    font-size: 3rem;
    font-weight: bold;
    color: white;
    margin-bottom: 15px;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
}

.game-over-subtitle {
    font-size: 1.3rem;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 30px;
}

.btn-play-again {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 15px 40px;
    font-size: 1.2rem;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.btn-play-again:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
}

/* Responsive Design */
@media (max-width: 768px) {
    .game-title {
        font-size: 2rem;
    }
    
    .connect4-board {
        grid-template-columns: repeat(7, 50px);
        grid-template-rows: repeat(6, 50px);
        gap: 6px;
        padding: 15px;
    }
    
    .connect4-cell {
        width: 50px;
        height: 50px;
    }
    
    .column-indicator {
        width: 50px;
        font-size: 18px;
    }
    
    .column-indicators {
        left: 15px;
        right: 15px;
        gap: 6px;
    }
    
    .game-over-title {
        font-size: 2rem;
    }
    
    .game-over-content {
        padding: 40px 30px;
    }
}
</style>

<script>
let board = [];
let gameOver = false;
let currentPlayer = 1;
let humanFirst = true;
let scores = {player: 0, ai: 0, draws: 0};
let winningCells = [];

function initializeGame() {
    board = Array(6).fill().map(() => Array(7).fill(0));
    gameOver = false;
    winningCells = [];
    renderBoard();
    updateGameMessage('Choose your settings and click "New Game" to start!');
}

function renderBoard() {
    const boardElement = document.getElementById('connect4-board');
    
    // Clear existing cells but keep indicators container
    const existingCells = boardElement.querySelectorAll('.connect4-cell');
    existingCells.forEach(cell => cell.remove());
    
    // Create column indicators if they don't exist
    let indicatorsContainer = document.getElementById('column-indicators');
    if (!indicatorsContainer) {
        indicatorsContainer = document.createElement('div');
        indicatorsContainer.id = 'column-indicators';
        indicatorsContainer.className = 'column-indicators';
        boardElement.appendChild(indicatorsContainer);
    }
    indicatorsContainer.innerHTML = '';
    
    for (let col = 0; col < 7; col++) {
        const indicator = document.createElement('div');
        indicator.className = 'column-indicator';
        indicator.textContent = 'â†“';
        indicator.dataset.col = col;
        if (!gameOver) {
            indicator.classList.add('active');
            indicator.addEventListener('click', () => makeMove(col));
            indicator.addEventListener('mouseenter', () => highlightColumn(col, true));
            indicator.addEventListener('mouseleave', () => highlightColumn(col, false));
        }
        indicatorsContainer.appendChild(indicator);
    }
    
    // Create board cells
    for (let row = 0; row < 6; row++) {
        for (let col = 0; col < 7; col++) {
            const cell = document.createElement('div');
            cell.className = 'connect4-cell';
            cell.dataset.row = row;
            cell.dataset.col = col;
            
            if (board[row][col] === 1) {
                cell.classList.add('player');
            } else if (board[row][col] === 2) {
                cell.classList.add('ai');
            }
            
            // Check if this cell is part of winning combination
            if (winningCells.some(wc => wc[0] === row && wc[1] === col)) {
                cell.classList.add('winning');
            }
            
            if (!gameOver && board[row][col] === 0) {
                cell.addEventListener('click', () => makeMove(col));
            }
            
            boardElement.appendChild(cell);
        }
    }
}

function highlightColumn(col, highlight) {
    if (gameOver) return;
    
    for (let row = 5; row >= 0; row--) {
        const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (board[row][col] === 0 && cell) {
            if (highlight) {
                cell.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
                cell.style.transform = 'scale(1.05)';
            } else {
                cell.style.background = '';
                cell.style.transform = '';
            }
            break;
        }
    }
}

function animatePieceDrop(row, col, player) {
    const boardElement = document.getElementById('connect4-board');
    const targetCell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    if (!targetCell) return;

    const rect = targetCell.getBoundingClientRect();
    const boardRect = boardElement.getBoundingClientRect();
    
    // Create a temporary falling piece
    const piece = document.createElement('div');
    piece.className = `connect4-cell ${player === 1 ? 'player' : 'ai'}`;
    piece.style.position = 'absolute';
    piece.style.left = `${rect.left - boardRect.left}px`;
    piece.style.top = `-100px`; // start above board
    piece.style.transition = 'top 2s cubic-bezier(0.34, 1.56, 0.64, 1)';
    piece.style.zIndex = 999;

    boardElement.appendChild(piece);

    // Start the fall animation
    requestAnimationFrame(() => {
        piece.style.top = `${rect.top - boardRect.top}px`;
    });

    // When done falling, attach it permanently to the grid
    setTimeout(() => {
        piece.remove();
        targetCell.classList.add(player === 1 ? 'player' : 'ai');
    }, 2000); // 2 seconds = 2000 ms
}


function makeMove(col) {
    if (gameOver) return;
    
    const difficulty = document.getElementById('difficulty').value;
    
    updateGameMessage('Making your move...');
    
    fetch('/connect4/api/make_move', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({column: col, difficulty: difficulty})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Find where player's piece landed
            let playerRow = -1;
            for (let r = 5; r >= 0; r--) {
                if (data.board[r][col] === 1 && board[r][col] === 0) {
                    playerRow = r;
                    break;
                }
            }
            
            board = data.board;
            
            if (playerRow >= 0) {
                animatePieceDrop(playerRow, col, 1);
            }
            
            setTimeout(() => {
                renderBoard();
                
                if (data.game_over) {
                    if (data.winner) {
                        winningCells = findWinningCells(board, data.winner === 'player' ? 1 : 2);
                        renderBoard();
                    }
                    handleGameEnd(data.winner);
                } else if (data.ai_move !== undefined) {
                    updateGameMessage('Bot is thinking...');
                    
                    setTimeout(() => {
                        // Find where Bot's piece landed
                        let aiRow = -1;
                        for (let r = 5; r >= 0; r--) {
                            if (data.board[r][data.ai_move] === 2) {
                                aiRow = r;
                                break;
                            }
                        }
                        
                        if (aiRow >= 0) {
                            animatePieceDrop(aiRow, data.ai_move, 2);
                        }
                        
                        setTimeout(() => {
                            if (data.game_over && data.winner) {
                                winningCells = findWinningCells(board, 2);
                                renderBoard();
                                handleGameEnd(data.winner);
                            } else {
                                renderBoard();
                                updateGameMessage('Your turn! Click a column to drop your piece.');
                            }
                        }, 100);
                    }, 500);
                } else {
                    updateGameMessage('Your turn! Click a column to drop your piece.');
                }
            }, 100);
        } else {
            updateGameMessage(data.message || 'Invalid move! Try another column.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        updateGameMessage('Connection error. Please try again.');
    });
}

function findWinningCells(board, player) {
    const winning = [];
    
    // Check horizontal
    for (let row = 0; row < 6; row++) {
        for (let col = 0; col < 4; col++) {
            if (board[row][col] === player &&
                board[row][col+1] === player &&
                board[row][col+2] === player &&
                board[row][col+3] === player) {
                winning.push([row, col], [row, col+1], [row, col+2], [row, col+3]);
                return winning;
            }
        }
    }
    
    // Check vertical
    for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 7; col++) {
            if (board[row][col] === player &&
                board[row+1][col] === player &&
                board[row+2][col] === player &&
                board[row+3][col] === player) {
                winning.push([row, col], [row+1, col], [row+2, col], [row+3, col]);
                return winning;
            }
        }
    }
    
    // Check diagonal (positive slope)
    for (let row = 3; row < 6; row++) {
        for (let col = 0; col < 4; col++) {
            if (board[row][col] === player &&
                board[row-1][col+1] === player &&
                board[row-2][col+2] === player &&
                board[row-3][col+3] === player) {
                winning.push([row, col], [row-1, col+1], [row-2, col+2], [row-3, col+3]);
                return winning;
            }
        }
    }
    
    // Check diagonal (negative slope)
    for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 4; col++) {
            if (board[row][col] === player &&
                board[row+1][col+1] === player &&
                board[row+2][col+2] === player &&
                board[row+3][col+3] === player) {
                winning.push([row, col], [row+1, col+1], [row+2, col+2], [row+3, col+3]);
                return winning;
            }
        }
    }
    
    return winning;
}

function handleGameEnd(winner) {
    gameOver = true;
    
    const overlay = document.getElementById('game-over-overlay');
    const icon = document.getElementById('game-over-icon');
    const title = document.getElementById('game-over-title');
    const subtitle = document.getElementById('game-over-subtitle');
    
    if (winner === 'player') {
        scores.player++;
        icon.textContent = 'ðŸŽ‰';
        title.textContent = 'You Win!';
        subtitle.textContent = 'Congratulations! You beat the Bot!';
    } else if (winner === 'ai') {
        scores.ai++;
        icon.textContent = 'ðŸ¤–';
        title.textContent = 'Bot Wins!';
        subtitle.textContent = 'The Bot outsmarted you this time!';
    } else {
        scores.draws++;
        icon.textContent = 'ðŸ¤';
        title.textContent = "It's a Draw!";
        subtitle.textContent = 'The board is full! Well played!';
    }
    
    updateScores();
    
    setTimeout(() => {
        overlay.classList.add('show');
    }, 1000);
}

function updateGameMessage(message) {
    document.getElementById('game-message').textContent = message;
}

function updateScores() {
    document.getElementById('player-score').textContent = scores.player;
    document.getElementById('ai-score').textContent = scores.ai;
    document.getElementById('draw-score').textContent = scores.draws;
}

document.getElementById('human-first').addEventListener('click', () => {
    document.getElementById('human-first').classList.add('active');
    document.getElementById('ai-first').classList.remove('active');
    humanFirst = true;
});

document.getElementById('ai-first').addEventListener('click', () => {
    document.getElementById('ai-first').classList.add('active');
    document.getElementById('human-first').classList.remove('active');
    humanFirst = false;
});

document.getElementById('new-game').addEventListener('click', startNewGame);
document.getElementById('play-again-btn').addEventListener('click', () => {
    document.getElementById('game-over-overlay').classList.remove('show');
    startNewGame();
});

function startNewGame() {
    const difficulty = document.getElementById('difficulty').value;
    winningCells = [];
    
    fetch('/connect4/api/new_game', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ai_first: !humanFirst, difficulty: difficulty})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            board = data.board;
            gameOver = false;
            renderBoard();
            
            if (data.ai_move !== undefined) {
                updateGameMessage("Bot made its move. Your turn!");
                
                // Find and animate Bot's first move
                setTimeout(() => {
                    let aiRow = -1;
                    for (let r = 5; r >= 0; r--) {
                        if (board[r][data.ai_move] === 2) {
                            aiRow = r;
                            break;
                        }
                    }
                    if (aiRow >= 0) {
                        animatePieceDrop(aiRow, data.ai_move, 2);
                    }
                }, 200);
            } else {
                updateGameMessage(data.message || 'Your turn! Click a column to drop your piece.');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        updateGameMessage('Connection error. Please try again.');
    });
}

// Initialize on load
initializeGame();
</script>
{% endblock %}